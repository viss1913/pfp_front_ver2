# Задача: Управление налоговыми ставками 2НДФЛ в админке

## Контекст
В админке уже реализовано управление продуктами и портфелями. Необходимо добавить управление налоговыми ставками 2НДФЛ в блок **Настройки (Settings)**.

## Описание задачи
Добавить в раздел **Настройки** возможность управления прогрессивной шкалой налогообложения 2НДФЛ. Администратор должен иметь возможность:
- Просматривать список всех налоговых ставок
- Добавлять новые налоговые ставки
- Редактировать существующие ставки
- Удалять ставки
- Создавать несколько ставок одновременно (bulk create)

## API Endpoints

Все endpoints находятся по пути: `/api/pfp/settings/tax-2ndfl/brackets`

### 1. Получить все налоговые ставки
```
GET /api/pfp/settings/tax-2ndfl/brackets
Authorization: Bearer {token}
```

**Response:**
```json
[
  {
    "id": 1,
    "income_from": 0,
    "income_to": 5000000,
    "rate": 13.0,
    "order_index": 1,
    "description": "Стандартная ставка 13%",
    "created_at": "2024-01-01T00:00:00.000Z",
    "updated_at": "2024-01-01T00:00:00.000Z"
  }
]
```

### 2. Получить ставку по ID
```
GET /api/pfp/settings/tax-2ndfl/brackets/{id}
Authorization: Bearer {token}
```

### 3. Найти ставку для конкретного дохода
```
GET /api/pfp/settings/tax-2ndfl/brackets/by-income/{income}
Authorization: Bearer {token}
```

**Пример:** `GET /api/pfp/settings/tax-2ndfl/brackets/by-income/3000000`

### 4. Создать новую ставку (admin only)
```
POST /api/pfp/settings/tax-2ndfl/brackets
Authorization: Bearer {token}
Content-Type: application/json
```

**Request Body:**
```json
{
  "income_from": 0,
  "income_to": 5000000,
  "rate": 13.0,
  "order_index": 1,
  "description": "Стандартная ставка 13%"
}
```

**Обязательные поля:**
- `income_from` (number, min: 0) - Доход в год от (руб.)
- `income_to` (number, min: 0) - Доход до, включая (руб.)
- `rate` (number, min: 0, max: 100) - Ставка налога (%)

**Опциональные поля:**
- `order_index` (integer, min: 0) - Порядок сортировки
- `description` (string) - Описание диапазона

**Response:** 201 Created
```json
{
  "id": 1,
  "income_from": 0,
  "income_to": 5000000,
  "rate": 13.0,
  "order_index": 1,
  "description": "Стандартная ставка 13%",
  "created_at": "2024-01-01T00:00:00.000Z",
  "updated_at": "2024-01-01T00:00:00.000Z"
}
```

**Ошибки:**
- `400` - Validation error or overlapping brackets (пересечение диапазонов)
- `403` - Forbidden (admin only)

### 5. Обновить ставку (admin only)
```
PUT /api/pfp/settings/tax-2ndfl/brackets/{id}
Authorization: Bearer {token}
Content-Type: application/json
```

**Request Body:** (все поля опциональны)
```json
{
  "income_from": 0,
  "income_to": 6000000,
  "rate": 13.0,
  "order_index": 1,
  "description": "Обновленное описание"
}
```

**Response:** 200 OK (возвращает обновленный объект)

**Ошибки:**
- `400` - Validation error or overlapping brackets
- `403` - Forbidden (admin only)
- `404` - Tax bracket not found

### 6. Удалить ставку (admin only)
```
DELETE /api/pfp/settings/tax-2ndfl/brackets/{id}
Authorization: Bearer {token}
```

**Response:** 204 No Content

**Ошибки:**
- `403` - Forbidden (admin only)
- `404` - Tax bracket not found

### 7. Массовое создание ставок (admin only)
```
POST /api/pfp/settings/tax-2ndfl/brackets/bulk
Authorization: Bearer {token}
Content-Type: application/json
```

**Request Body:**
```json
{
  "brackets": [
    {
      "income_from": 0,
      "income_to": 5000000,
      "rate": 13.0,
      "order_index": 1,
      "description": "Стандартная ставка 13%"
    },
    {
      "income_from": 5000001,
      "income_to": 20000000,
      "rate": 15.0,
      "order_index": 2,
      "description": "Повышенная ставка 15%"
    }
  ]
}
```

**Response:** 201 Created (массив созданных ставок)

**Ошибки:**
- `400` - Validation error or overlapping brackets
- `403` - Forbidden (admin only)

## Требования к UI

### 1. Размещение
Добавить в существующий блок **Настройки (Settings)** новую секцию/вкладку **"Налоги 2НДФЛ"** или **"Налоговые ставки"**.

### 2. Список ставок
- Таблица со всеми налоговыми ставками
- Колонки:
  - ID (опционально, для отладки)
  - Доход от (руб.)
  - Доход до (руб.)
  - Ставка (%)
  - Порядок
  - Описание
  - Действия (редактировать, удалить)
- Сортировка по `order_index` и `income_from`
- Форматирование чисел (разделители тысяч для сумм)

### 3. Форма создания/редактирования
- Поля:
  - Доход от (руб.) - обязательное, число >= 0
  - Доход до (руб.) - обязательное, число >= 0, должно быть > income_from
  - Ставка (%) - обязательное, число от 0 до 100
  - Порядок - опциональное, целое число >= 0
  - Описание - опциональное, текст
- Валидация:
  - Проверка, что `income_to > income_from`
  - Проверка диапазонов (0-100 для ставки)
  - Проверка на пересечение с существующими диапазонами (сервер вернет ошибку 400, нужно показать пользователю)

### 4. Массовое создание
- Кнопка "Добавить несколько"
- Форма с возможностью добавить несколько строк одновременно
- Кнопка "Добавить строку" для добавления новой строки в форму
- Валидация всех строк перед отправкой

### 5. Поиск ставки по доходу
- Опционально: поле для ввода дохода и кнопка "Найти ставку"
- Показ найденной ставки или сообщения "Не найдено"

### 6. Обработка ошибок
- При ошибке 400 (пересечение диапазонов) показать понятное сообщение:
  - "Диапазон доходов пересекается с существующей ставкой: [диапазон]"
- При ошибке 403 показать: "Только администратор может управлять налоговыми ставками"
- При ошибке 404 показать: "Налоговая ставка не найдена"

## Примеры использования

### Пример прогрессивной шкалы:
```json
[
  {
    "income_from": 0,
    "income_to": 5000000,
    "rate": 13.0,
    "order_index": 1,
    "description": "Стандартная ставка 13%"
  },
  {
    "income_from": 5000001,
    "income_to": 20000000,
    "rate": 15.0,
    "order_index": 2,
    "description": "Повышенная ставка 15%"
  },
  {
    "income_from": 20000001,
    "income_to": 50000000,
    "rate": 20.0,
    "order_index": 3,
    "description": "Высокая ставка 20%"
  }
]
```

## Важные замечания

1. **Права доступа:** Все операции создания, обновления и удаления требуют прав администратора. GET запросы доступны всем авторизованным пользователям.

2. **Пересечение диапазонов:** Сервер автоматически проверяет, что диапазоны доходов не пересекаются. При попытке создать/обновить ставку с пересекающимся диапазоном вернется ошибка 400.

3. **Сортировка:** Ставки должны отображаться отсортированными по `order_index` (по возрастанию), затем по `income_from` (по возрастанию).

4. **Форматирование:** 
   - Суммы доходов отображать с разделителями тысяч (например: 5 000 000 руб.)
   - Ставки отображать с одним знаком после запятой (например: 13.0%)

5. **UX рекомендации:**
   - При удалении ставки показывать подтверждение
   - При редактировании показывать текущие значения
   - При создании нескольких ставок показывать прогресс/статус

## API спецификация
Полная спецификация API доступна в файле `OPENAPI_SPEC.yaml` (раздел `/pfp/settings/tax-2ndfl/brackets`).

