openapi: 3.0.0
info:
  title: Portfolio API
  version: 1.0.0
  description: |
    API для управления портфелями.
    
    **Авторизация:**
    1. Получите JWT токен через POST /api/auth/login
    2. Используйте токен в заголовке: Authorization: Bearer {token}
    
    **Важно при обновлении портфеля:**
    - Получите текущий портфель через GET
    - Измените нужные поля
    - Отправьте весь объект обратно через PUT

servers:
  - url: https://pfpbackend-production.up.railway.app/api
    description: Production server

paths:
  /pfp/portfolios:
    get:
      summary: Получить список портфелей
      tags: [Portfolios]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Список портфелей
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Portfolio'
    
    post:
      summary: Создать портфель
      tags: [Portfolios]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PortfolioCreate'
      responses:
        '201':
          description: Портфель создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Portfolio'

  /pfp/portfolios/{id}:
    get:
      summary: Получить портфель по ID
      tags: [Portfolios]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Портфель
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Portfolio'
        '404':
          description: Портфель не найден
    
    put:
      summary: Обновить портфель
      description: |
        **Важно:** Рекомендуется отправлять все данные портфеля целиком, включая все поля.
        Получите текущий портфель через GET, измените нужные поля и отправьте обратно через PUT.
      tags: [Portfolios]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PortfolioUpdate'
            example:
              name: "Консервативный портфель"
              currency: "RUB"
              amount_from: 100000
              amount_to: 10000000
              term_from_months: 12
              term_to_months: 60
              age_from: 25
              age_to: 55
              investor_type: "QUALIFIED"
              gender: "MALE"
              classes: [2, 3, 4]
              riskProfiles:
                - profile_type: "CONSERVATIVE"
                  instruments:
                    - product_id: 3
                      bucket_type: "INITIAL_CAPITAL"
                      share_percent: 70.0
                      order_index: 1
                    - product_id: 4
                      bucket_type: "INITIAL_CAPITAL"
                      share_percent: 30.0
                      order_index: 2
                    - product_id: 3
                      bucket_type: "TOP_UP"
                      share_percent: 100.0
                      order_index: 1
                - profile_type: "BALANCED"
                  instruments:
                    - product_id: 3
                      bucket_type: "INITIAL_CAPITAL"
                      share_percent: 100.0
                      order_index: 1
                    - product_id: 3
                      bucket_type: "TOP_UP"
                      share_percent: 100.0
                      order_index: 1
                - profile_type: "AGGRESSIVE"
                  instruments:
                    - product_id: 3
                      bucket_type: "INITIAL_CAPITAL"
                      share_percent: 100.0
                      order_index: 1
                    - product_id: 3
                      bucket_type: "TOP_UP"
                      share_percent: 100.0
                      order_index: 1
      responses:
        '200':
          description: Портфель обновлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Portfolio'
        '400':
          description: Ошибка валидации
        '404':
          description: Портфель не найден
    
    delete:
      summary: Удалить портфель
      tags: [Portfolios]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Портфель удален

  /pfp/portfolios/classes:
    get:
      summary: Получить список классов портфелей
      tags: [Portfolios]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Список классов
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PortfolioClass'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Portfolio:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
          example: "Консервативный портфель"
        currency:
          type: string
          example: "RUB"
        amount_from:
          type: number
          example: 100000
        amount_to:
          type: number
          example: 10000000
        term_from_months:
          type: integer
          example: 12
        term_to_months:
          type: integer
          example: 60
        age_from:
          type: integer
          nullable: true
          example: 25
        age_to:
          type: integer
          nullable: true
          example: 55
        investor_type:
          type: string
          nullable: true
          example: "QUALIFIED"
        gender:
          type: string
          nullable: true
          example: "MALE"
        classes:
          type: array
          items:
            $ref: '#/components/schemas/PortfolioClass'
        riskProfiles:
          type: array
          items:
            $ref: '#/components/schemas/RiskProfile'
          description: Массив риск-профилей (camelCase)

    PortfolioCreate:
      type: object
      required:
        - name
        - currency
        - amount_from
        - amount_to
        - term_from_months
        - term_to_months
      example:
        name: "Консервативный портфель"
        currency: "RUB"
        amount_from: 100000
        amount_to: 10000000
        term_from_months: 12
        term_to_months: 60
        age_from: 25
        age_to: 55
        classes: [1, 2, 3]
        riskProfiles:
          - profile_type: "CONSERVATIVE"
            instruments:
              - product_id: 3
                bucket_type: "INITIAL_CAPITAL"
                share_percent: 50.0
                order_index: 1
              - product_id: 4
                bucket_type: "INITIAL_CAPITAL"
                share_percent: 50.0
                order_index: 2
              - product_id: 3
                bucket_type: "TOP_UP"
                share_percent: 100.0
                order_index: 1
          - profile_type: "BALANCED"
            instruments:
              - product_id: 3
                bucket_type: "INITIAL_CAPITAL"
                share_percent: 100.0
      properties:
        name:
          type: string
          example: "Консервативный портфель"
        currency:
          type: string
          default: "RUB"
          example: "RUB"
        amount_from:
          type: number
          example: 100000
        amount_to:
          type: number
          example: 10000000
        term_from_months:
          type: integer
          example: 12
        term_to_months:
          type: integer
          example: 60
        age_from:
          type: integer
          nullable: true
          example: 25
        age_to:
          type: integer
          nullable: true
          example: 55
        investor_type:
          type: string
          nullable: true
          example: "QUALIFIED"
        gender:
          type: string
          nullable: true
          example: "MALE"
        classes:
          type: array
          items:
            type: integer
          description: Массив ID классов портфеля
          example: [1, 2, 3]
        riskProfiles:
          type: array
          items:
            $ref: '#/components/schemas/RiskProfile'
          description: Массив риск-профилей

    PortfolioUpdate:
      type: object
      description: |
        **Рекомендуется отправлять все данные портфеля целиком.**
        
        Алгоритм обновления:
        1. Получите текущий портфель через GET /pfp/portfolios/{id}
        2. Измените нужные поля
        3. Отправьте весь объект обратно через PUT
        
        Все поля опциональны для обратной совместимости, но рекомендуется заполнять все.
      example:
        name: "Консервативный портфель"
        currency: "RUB"
        amount_from: 100000
        amount_to: 10000000
        term_from_months: 12
        term_to_months: 60
        age_from: 25
        age_to: 55
        investor_type: "QUALIFIED"
        gender: "MALE"
        classes: [2, 3, 4]
        riskProfiles:
          - profile_type: "CONSERVATIVE"
            instruments:
              - product_id: 3
                bucket_type: "INITIAL_CAPITAL"
                share_percent: 70.0
                order_index: 1
              - product_id: 4
                bucket_type: "INITIAL_CAPITAL"
                share_percent: 30.0
                order_index: 2
              - product_id: 3
                bucket_type: "TOP_UP"
                share_percent: 100.0
                order_index: 1
          - profile_type: "BALANCED"
            instruments:
              - product_id: 3
                bucket_type: "INITIAL_CAPITAL"
                share_percent: 100.0
                order_index: 1
              - product_id: 3
                bucket_type: "TOP_UP"
                share_percent: 100.0
                order_index: 1
          - profile_type: "AGGRESSIVE"
            instruments:
              - product_id: 3
                bucket_type: "INITIAL_CAPITAL"
                share_percent: 100.0
                order_index: 1
              - product_id: 3
                bucket_type: "TOP_UP"
                share_percent: 100.0
                order_index: 1
      properties:
        name:
          type: string
        currency:
          type: string
        amount_from:
          type: number
        amount_to:
          type: number
        term_from_months:
          type: integer
        term_to_months:
          type: integer
        age_from:
          type: integer
          nullable: true
        age_to:
          type: integer
          nullable: true
        investor_type:
          type: string
          nullable: true
        gender:
          type: string
          nullable: true
        classes:
          type: array
          items:
            type: integer
          description: Массив ID классов портфеля
        riskProfiles:
          type: array
          items:
            $ref: '#/components/schemas/RiskProfile'
          description: Массив риск-профилей

    RiskProfile:
      type: object
      required:
        - profile_type
      properties:
        profile_type:
          type: string
          enum: [CONSERVATIVE, BALANCED, AGGRESSIVE]
          example: "CONSERVATIVE"
        potential_yield_percent:
          type: number
          nullable: true
          description: Рассчитывается автоматически, можно не отправлять
        instruments:
          type: array
          items:
            $ref: '#/components/schemas/Instrument'
          description: Массив инструментов портфеля

    Instrument:
      type: object
      required:
        - product_id
        - share_percent
      properties:
        product_id:
          type: integer
          description: ID продукта
          example: 3
        bucket_type:
          type: string
          enum: [INITIAL_CAPITAL, TOP_UP]
          nullable: true
          description: INITIAL_CAPITAL - стартовый капитал, TOP_UP - пополнения
          example: "INITIAL_CAPITAL"
        share_percent:
          type: number
          description: Доля в процентах
          example: 50.0
        order_index:
          type: integer
          nullable: true
          description: Порядок сортировки
          example: 1

    PortfolioClass:
      type: object
      properties:
        id:
          type: integer
          example: 1
        code:
          type: string
          example: "PENSION"
        name:
          type: string
          example: "Пенсия"

